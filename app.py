import streamlit as st
import requests
from datetime import datetime

# Load API key from Streamlit Secrets (MUST SET REAL KEY for weather to work)
WEATHER_API_KEY = st.secrets.get("WEATHER_API_KEY", "a471efb91f4c4e29ac9135831252209")

# Crop to pesticide mapping (Hindi descriptions)
pesticide_suggestions = {
    "wheat": "рдлрдВрдЧреАрд╕рд╛рдЗрдб XYZ (рдЙрджрд╛рд╣рд░рдг: рдХрд╛рд░реНрдмреЗрдВрдбрд╛рдЬрд┐рдо) - рдЬрдВрдЧ рдФрд░ рд╕реНрдордЯ рд╕реЗ рд╕реБрд░рдХреНрд╖рд╛ред",
    "rice": "рдХреАрдЯрдирд╛рд╢рдХ ABC (рдЙрджрд╛рд╣рд░рдг: рдЗрдорд┐рдбрд╛рдХреНрд▓реЛрдкреНрд░рд┐рдб) - рддрдирд╛ рдмреЛрд░рд░ рдФрд░ рдкрддреНрддреА рдлреЛрд▓реНрдбрд░ рдирд┐рдпрдВрддреНрд░рдгред",
    "maize": "рдЦрд░рдкрддрд╡рд╛рд░рдирд╛рд╢рдХ DEF (рдЙрджрд╛рд╣рд░рдг: рдПрдЯреНрд░рд╛рдЬреАрди) - рдШрд╛рд╕ рдФрд░ рдЪреМрдбрд╝реА рдкрддреНрддреА рд╡рд╛рд▓реЗ рдЦрд░рдкрддрд╡рд╛рд░ рдкреНрд░рдмрдВрдзрдиред",
    "cotton": "рдХреАрдЯрдирд╛рд╢рдХ GHI (рдЙрджрд╛рд╣рд░рдг: рдПрдВрдбреЛрд╕рд▓реНрдлрд╛рди) - рдмреЛрд▓рд╡рд░реНрдо рдФрд░ рдПрдлрд┐рдбреНрд╕ рдкрд░ рдирд┐рд╢рд╛рдирд╛ред",
    "sugarcane": "рдХреАрдЯрдирд╛рд╢рдХ JKL (рдЙрджрд╛рд╣рд░рдг: рдХреНрд▓реЛрд░рдкрд╛рдпрд░реАрдлреЙрд╕) - рдмреЛрд░рд░ рдФрд░ рджреАрдордХ рд╕реЗ рд▓рдбрд╝рд╛рдИред",
}

# All 28 Indian States with 4-5 major districts (Hindi for UI)
states_districts = {
    "рдЖрдВрдзреНрд░ рдкреНрд░рджреЗрд╢": ["рд╡рд┐рд╢рд╛рдЦрд╛рдкрддреНрддрдирдо", "рд╡рд┐рдЬрдпрд╡рд╛рдбрд╝рд╛", "рдЧреБрдВрдЯреВрд░", "рдХреБрд░рдиреВрд▓", "рдЕрдирдВрддрдкреБрд░"],
    "рдЕрд░реБрдгрд╛рдЪрд▓ рдкреНрд░рджреЗрд╢": ["рдЗрдЯрд╛рдирдЧрд░", "рддрд╡рд╛рдВрдЧ", "рдкрд╛рдкреБрдо рдкрд╛рд░реЗ", "рд▓реЛрд╣рд┐рдд"],
    "рдЕрд╕рдо": ["рдЧреБрд╡рд╛рд╣рд╛рдЯреА", "рдбрд┐рдмреНрд░реВрдЧрдврд╝", "рдЬреЛрд░рд╣рд╛рдЯ", "рд╕рд┐рд▓рдЪрд░", "рдХрд╛рдорд░реВрдк"],
    "рдмрд┐рд╣рд╛рд░": ["рдкрдЯрдирд╛", "рдЧрдпрд╛", "рднрд╛рдЧрд▓рдкреБрд░", "рдореБрдЬрдлреНрдлрд░рдкреБрд░", "рдкреВрд░реНрдгрд┐рдпрд╛"],
    "рдЫрддреНрддреАрд╕рдЧрдврд╝": ["рд░рд╛рдпрдкреБрд░", "рджреБрд░реНрдЧ", "рдмрд┐рд▓рд╛рд╕рдкреБрд░", "рд░рд╛рдпрдЧрдврд╝", "рдЬрд╛рдВрдЬрдЧреАрд░-рдЪрд╛рдВрдкрд╛"],
    "рдЧреЛрд╡рд╛": ["рдкрдгрдЬреА", "рдорд╛рд░реНрдЧрд╛рд╡", "рд╕рд╛рдЙрд╕ рдЧреЛрд╡рд╛", "рдиреЙрд░реНрде рдЧреЛрд╡рд╛"],
    "рдЧреБрдЬрд░рд╛рдд": ["рдЕрд╣рдорджрд╛рдмрд╛рдж", "рд╕реВрд░рдд", "рд╡рдбреЛрджрд░рд╛", "рд░рд╛рдЬрдХреЛрдЯ", "рднрд╛рд╡рдирдЧрд░"],
    "рд╣рд░рд┐рдпрд╛рдгрд╛": ["рдХрд░рдирд╛рд▓", "рдЕрдВрдмрд╛рд▓рд╛", "рдХреБрд░реБрдХреНрд╖реЗрддреНрд░", "рд╕рд┐рд░рд╕рд╛", "рдлрд░реАрджрд╛рдмрд╛рдж"],
    "рд╣рд┐рдорд╛рдЪрд▓ рдкреНрд░рджреЗрд╢": ["рд╢рд┐рдорд▓рд╛", "рдордВрдбреА", "рдХреБрд▓реНрд▓реВ", "рдХрд╛рдВрдЧрдбрд╝рд╛", "рд╕реЛрд▓рди"],
    "рдЭрд╛рд░рдЦрдВрдб": ["рд░рд╛рдВрдЪреА", "рдзрдирдмрд╛рдж", "рдЬрдорд╢реЗрджрдкреБрд░", "рдЧрд┐рд░рд┐рдбреАрд╣", "рд╣рдЬрд╛рд░реАрдмрд╛рдЧ"],
    "рдХрд░реНрдирд╛рдЯрдХ": ["рдмреЗрдВрдЧрд▓реБрд░реБ", "рдореИрд╕реВрд░", "рд╣реБрдмрд▓реА", "рдмреЗрд▓рдЧрд╛рдо", "рдордВрдЧрд▓реБрд░реБ"],
    "рдХреЗрд░рд▓": ["рддрд┐рд░реБрд╡рдирдВрддрдкреБрд░рдо", "рдХреЛрдЪреНрдЪрд┐", "рдХреЛрдЭрд┐рдХреЛрдб", "рддреНрд░рд┐рд╢реВрд░", "рдХреЛрдЯреНрдЯрд╛рдпрдо"],
    "рдордзреНрдп рдкреНрд░рджреЗрд╢": ["рднреЛрдкрд╛рд▓", "рдЗрдВрджреМрд░", "рдЧреНрд╡рд╛рд▓рд┐рдпрд░", "рдЬрдмрд▓рдкреБрд░", "рдЙрдЬреНрдЬреИрди"],
    "рдорд╣рд╛рд░рд╛рд╖реНрдЯреНрд░": ["рдореБрдВрдмрдИ", "рдкреБрдгреЗ", "рдирд╛рдЧрдкреБрд░", "рдирд╛рд╕рд┐рдХ", "рдЕрдорд░рд╛рд╡рддреА"],
    "рдордгрд┐рдкреБрд░": ["рдЗрдореНрдлрд╛рд▓ рдкреВрд░реНрд╡", "рдЗрдореНрдлрд╛рд▓ рдкрд╢реНрдЪрд┐рдо", "рдмрд┐рд╢реНрдиреБрдкреБрд░", "рдереМрдмрд▓"],
    "рдореЗрдШрд╛рд▓рдп": ["рд╢рд┐рд▓рд╛рдВрдЧ", "рдИрд╕реНрдЯ рдЦрд╛рд╕реА рд╣рд┐рд▓реНрд╕", "рд╡реЗрд╕реНрдЯ рдЧрд╛рд░реЛ рд╣рд┐рд▓реНрд╕", "рдИрд╕реНрдЯ рдЧрд╛рд░реЛ рд╣рд┐рд▓реНрд╕"],
    "рдорд┐рдЬреЛрд░рдо": ["рдЖрдЗрдЬреЛрд▓", "рд▓реБрдВрдЧрд▓реЗрдИ", "рдЪрдореНрдлрд╛рдИ", "рдХреМрд▓рдХ"],
    "рдирд╛рдЧрд╛рд▓реИрдВрдб": ["рдХреЛрд╣рд┐рдорд╛", "рджрд┐рдорд╛рдкреБрд░", "рдореЛрдХреЛрдХрдЪреБрдВрдЧ", "рддреБрдХреЗрд╕рд╛рдВрдЧ"],
    "рдУрдбрд┐рд╢рд╛": ["рднреБрд╡рдиреЗрд╢реНрд╡рд░", "рдХрдЯрдХ", "рдмрд░рдореНрдкреБрд░", "рд░рд╛рдЙрд░рдХреЗрд▓рд╛", "рдмрд╛рд▓рд╛рд╕реЛрд░"],
    "рдкрдВрдЬрд╛рдм": ["рд▓реБрдзрд┐рдпрд╛рдирд╛", "рдЕрдореГрддрд╕рд░", "рдЬрд╛рд▓рдВрдзрд░", "рдкрдЯрд┐рдпрд╛рд▓рд╛", "рдмрдард┐рдВрдбрд╛"],
    "рд░рд╛рдЬрд╕реНрдерд╛рди": ["рдЬрдпрдкреБрд░", "рдЬреЛрдзрдкреБрд░", "рдЙрджрдпрдкреБрд░", "рдХреЛрдЯрд╛", "рдмреАрдХрд╛рдиреЗрд░"],
    "рд╕рд┐рдХреНрдХрд┐рдо": ["рдЧрдВрдЧрдЯреЛрдХ", "рдордВрдЧрди", "рдИрд╕реНрдЯ рд╕рд┐рдХреНрдХрд┐рдо", "рд╡реЗрд╕реНрдЯ рд╕рд┐рдХреНрдХрд┐рдо"],
    "рддрдорд┐рд▓рдирд╛рдбреБ": ["рдЪреЗрдиреНрдирдИ", "рдХреЛрдпрдВрдмрдЯреВрд░", "рдорджреБрд░реИ", "рддрд┐рд░реБрдЪрд┐рд░рд╛рдкрд▓реНрд▓реА", "рд╕рд▓реЗрдо"],
    "рддреЗрд▓рдВрдЧрд╛рдирд╛": ["рд╣реИрджрд░рд╛рдмрд╛рдж", "рд╡рд░рдВрдЧрд▓", "рдирд┐рдЬрд╛рдорд╛рдмрд╛рдж", "рдЦрдореНрдордо", "рдорд╣рдмреВрдмрдирдЧрд░"],
    "рддреНрд░рд┐рдкреБрд░рд╛": ["рдЕрдЧрд░рддрд▓рд╛", "рдЙрдирд╛рдХреЛрдЯреА", "рд╡реЗрд╕реНрдЯ рддреНрд░рд┐рдкреБрд░рд╛", "рд╕рд┐рдкрд╛рд╣рд┐рдЬрд╛рд▓рд╛"],
    "рдЙрддреНрддрд░ рдкреНрд░рджреЗрд╢": ["рд▓рдЦрдирдК", "рдХрд╛рдирдкреБрд░", "рдЖрдЧрд░рд╛", "рд╡рд╛рд░рд╛рдгрд╕реА", "рдореЗрд░рда"],
    "рдЙрддреНрддрд░рд╛рдЦрдВрдб": ["рджреЗрд╣рд░рд╛рджреВрди", "рд╣рд░рд┐рджреНрд╡рд╛рд░", "рдЙрдзрдо рд╕рд┐рдВрд╣ рдирдЧрд░", "рдиреИрдиреАрддрд╛рд▓"],
    "рдкрд╢реНрдЪрд┐рдо рдмрдВрдЧрд╛рд▓": ["рдХреЛрд▓рдХрд╛рддрд╛", "рд╣рд╛рд╡рдбрд╝рд╛", "рджрд░рдЬреАрд▓рд┐рдВрдЧ", "рдмрд░реНрдзрдорд╛рди", "рдорд╛рд▓рджрд╛"],
}

# Hindi District to English City Mapping (for Weather API - fixes wrong weather)
district_english_map = {
    "рд▓реБрдзрд┐рдпрд╛рдирд╛": "Ludhiana", "рдЕрдореГрддрд╕рд░": "Amritsar", "рдЬрд╛рд▓рдВрдзрд░": "Jalandhar", "рдкрдЯрд┐рдпрд╛рд▓рд╛": "Patiala", "рдмрдард┐рдВрдбрд╛": "Bathinda",
    "рдХрд░рдирд╛рд▓": "Karnal", "рдЕрдВрдмрд╛рд▓рд╛": "Ambala", "рдХреБрд░реБрдХреНрд╖реЗрддреНрд░": "Kurukshetra", "рд╕рд┐рд░рд╕рд╛": "Sirsa", "рдлрд░реАрджрд╛рдмрд╛рдж": "Faridabad",
    "рд▓рдЦрдирдК": "Lucknow", "рдХрд╛рдирдкреБрд░": "Kanpur", "рдЖрдЧрд░рд╛": "Agra", "рд╡рд╛рд░рд╛рдгрд╕реА": "Varanasi", "рдореЗрд░рда": "Meerut",
    "рдореБрдВрдмрдИ": "Mumbai", "рдкреБрдгреЗ": "Pune", "рдирд╛рдЧрдкреБрд░": "Nagpur", "рдирд╛рд╕рд┐рдХ": "Nashik", "рдЕрдорд░рд╛рд╡рддреА": "Amravati",
    "рдЬрдпрдкреБрд░": "Jaipur", "рдЬреЛрдзрдкреБрд░": "Jodhpur", "рдЙрджрдпрдкреБрд░": "Udaipur", "рдХреЛрдЯрд╛": "Kota", "рдмреАрдХрд╛рдиреЗрд░": "Bikaner",
    "рднреЛрдкрд╛рд▓": "Bhopal", "рдЗрдВрджреМрд░": "Indore", "рдЧреНрд╡рд╛рд▓рд┐рдпрд░": "Gwalior", "рдЬрдмрд▓рдкреБрд░": "Jabalpur", "рдЙрдЬреНрдЬреИрди": "Ujjain",
    "рдЕрд╣рдорджрд╛рдмрд╛рдж": "Ahmedabad", "рд╕реВрд░рдд": "Surat", "рд╡рдбреЛрджрд░рд╛": "Vadodara", "рд░рд╛рдЬрдХреЛрдЯ": "Rajkot", "рднрд╛рд╡рдирдЧрд░": "Bhavnagar",
    "рдкрдЯрдирд╛": "Patna", "рдЧрдпрд╛": "Gaya", "рднрд╛рдЧрд▓рдкреБрд░": "Bhagalpur", "рдореБрдЬрдлреНрдлрд░рдкреБрд░": "Muzaffarpur", "рдкреВрд░реНрдгрд┐рдпрд╛": "Purnia",
    "рд╡рд┐рд╢рд╛рдЦрд╛рдкрддреНрддрдирдо": "Visakhapatnam", "рд╡рд┐рдЬрдпрд╡рд╛рдбрд╝рд╛": "Vijayawada", "рдЧреБрдВрдЯреВрд░": "Guntur", "рдХреБрд░рдиреВрд▓": "Kurnool", "рдЕрдирдВрддрдкреБрд░": "Anantapur",
    "рдмреЗрдВрдЧрд▓реБрд░реБ": "Bengaluru", "рдореИрд╕реВрд░": "Mysore", "рд╣реБрдмрд▓реА": "Hubli", "рдмреЗрд▓рдЧрд╛рдо": "Belgaum", "рдордВрдЧрд▓реБрд░реБ": "Mangalore",
    "рдЪреЗрдиреНрдирдИ": "Chennai", "рдХреЛрдпрдВрдмрдЯреВрд░": "Coimbatore", "рдорджреБрд░реИ": "Madurai", "рддрд┐рд░реБрдЪрд┐рд░рд╛рдкрд▓реНрд▓реА": "Tiruchirappalli", "рд╕рд▓реЗрдо": "Salem",
    "рд╣реИрджрд░рд╛рдмрд╛рдж": "Hyderabad", "рд╡рд░рдВрдЧрд▓": "Warangal", "рдирд┐рдЬрд╛рдорд╛рдмрд╛рдж": "Nizamabad", "рдЦрдореНрдордо": "Khammam", "рдорд╣рдмреВрдмрдирдЧрд░": "Mahbubnagar",
    "рдХреЛрд▓рдХрд╛рддрд╛": "Kolkata", "рд╣рд╛рд╡рдбрд╝рд╛": "Howrah", "рджрд░рдЬреАрд▓рд┐рдВрдЧ": "Darjeeling", "рдмрд░реНрдзрдорд╛рди": "Bardhaman", "рдорд╛рд▓рджрд╛": "Malda",
    "рджреЗрд╣рд░рд╛рджреВрди": "Dehradun", "рд╣рд░рд┐рджреНрд╡рд╛рд░": "Haridwar", "рдЙрдзрдо рд╕рд┐рдВрд╣ рдирдЧрд░": "Udham Singh Nagar", "рдиреИрдиреАрддрд╛рд▓": "Nainital",
    "рд╢рд┐рдорд▓рд╛": "Shimla", "рдордВрдбреА": "Mandi", "рдХреБрд▓реНрд▓реВ": "Kullu", "рдХрд╛рдВрдЧрдбрд╝рд╛": "Kangra", "рд╕реЛрд▓рди": "Solan",
    "рд░рд╛рдВрдЪреА": "Ranchi", "рдзрдирдмрд╛рдж": "Dhanbad", "рдЬрдорд╢реЗрджрдкреБрд░": "Jamshedpur", "рдЧрд┐рд░рд┐рдбреАрд╣": "Giridih", "рд╣рдЬрд╛рд░реАрдмрд╛рдЧ": "Hazaribagh",
    "рднреБрд╡рдиреЗрд╢реНрд╡рд░": "Bhubaneswar", "рдХрдЯрдХ": "Cuttack", "рдмрд░рдореНрдкреБрд░": "Berhampur", "рд░рд╛рдЙрд░рдХреЗрд▓рд╛": "Rourkela", "рдмрд╛рд▓рд╛рд╕реЛрд░": "Balasore",
    "рдЗрдЯрд╛рдирдЧрд░": "Itanagar", "рдЧреБрд╡рд╛рд╣рд╛рдЯреА": "Guwahati", "рд░рд╛рдпрдкреБрд░": "Raipur", "рдкрдгрдЬреА": "Panaji", "рддрд┐рд░реБрд╡рдирдВрддрдкреБрд░рдо": "Thiruvananthapuram",
    "рдЗрдореНрдлрд╛рд▓ рдкреВрд░реНрд╡": "Imphal", "рд╢рд┐рд▓рд╛рдВрдЧ": "Shillong", "рдЖрдЗрдЬреЛрд▓": "Aizawl", "рдХреЛрд╣рд┐рдорд╛": "Kohima", "рдЧрдВрдЧрдЯреЛрдХ": "Gangtok", "рдЕрдЧрд░рддрд▓рд╛": "Agartala",
}

# Real crop prices (Oct 2024 national averages - static for stability)
crop_prices = {
    "wheat": {"modal_price": 2450, "min_price": 2400, "max_price": 2500, "avg_yield_quintal_per_acre": 20},
    "rice": {"modal_price": 2150, "min_price": 2100, "max_price": 2200, "avg_yield_quintal_per_acre": 25},
    "maize": {"modal_price": 1850, "min_price": 1800, "max_price": 1900, "avg_yield_quintal_per_acre": 18},
    "cotton": {"modal_price": 6700, "min_price": 6600, "max_price": 6800, "avg_yield_quintal_per_acre": 10},
    "sugarcane": {"modal_price": 360, "min_price": 350, "max_price": 370, "avg_yield_quintal_per_acre": 400},
}

# Streamlit config
st.set_page_config(page_title="рдлрд╕рд▓ рд╕рд▓рд╛рд╣ рдЪреИрдЯрдмреЙрдЯ", page_icon="ЁЯМдя╕П", layout="centered")
st.title("ЁЯМдя╕П рднрд╛рд░рддреАрдп рдХрд┐рд╕рд╛рдиреЛрдВ рдХреЗ рд▓рд┐рдП рдореМрд╕рдо, рд╕рд▓рд╛рд╣ рдФрд░ рд▓рд╛рдн рдХреИрд▓рдХреБрд▓реЗрдЯрд░")
st.markdown("---")

# Session state initialization
if "step" not in st.session_state:
    st.session_state.step = 0  # 0: State, 1: District, 2: Weather & Crop Select, 3: Pesticide, 4: Prices, 5: Profit
if "selected_state" not in st.session_state:
    st.session_state.selected_state = ""
if "selected_district" not in st.session_state:
    st.session_state.selected_district = ""
if "selected_crop" not in st.session_state:
    st.session_state.selected_crop = ""
if "total_cost" not in st.session_state:
    st.session_state.total_cost = 0
if "revenue_estimate" not in st.session_state:
    st.session_state.revenue_estimate = 0

# Weather fetch function (with English mapping)
@st.cache_data(ttl=1800)
def get_10day_forecast(hindi_district):
    english_district = district_english_map.get(hindi_district, hindi_district)
    days = 10
    url = f"http://api.weatherapi.com/v1
